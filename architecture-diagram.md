# DDD 架构图示

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Interface Layer                         │
│                      (接口层)                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  RecommendationHandler                               │   │
│  │  - GetFollowingBasedRecommendations()                │   │
│  │  - 协议适配 (RPC 请求/响应转换)                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                         │
│                    (应用层)                                   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  RecommendationService                               │   │
│  │  - GetFollowingBasedRecommendations()                │   │
│  │  - 用例编排、跨服务调用、DTO转换                       │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  DTO (数据传输对象)                                   │   │
│  │  - RecommendationResponse                            │   │
│  │  - UserRecommendationDTO                             │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      Domain Layer                            │
│                      (领域层 - 核心)                          │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Aggregate (聚合)                                     │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  UserRecommendation (聚合根)                   │  │   │
│  │  │  - 推荐分数计算                                 │  │   │
│  │  │  - 过期判断                                     │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  RecommendationList (聚合根)                   │  │   │
│  │  │  - 添加推荐                                     │  │   │
│  │  │  - 获取Top N                                    │  │   │
│  │  │  - 移除过期                                     │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Value Object (值对象)                                │   │
│  │  - UserID                                            │   │
│  │  - RecommendationID                                  │   │
│  │  - RecommendationReason                              │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Domain Service (领域服务)                            │   │
│  │  - RecommendationGenerator                           │   │
│  │    (推荐生成逻辑)                                     │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Repository Interface (仓储接口)                      │   │
│  │  - SocialGraphRepository                             │   │
│  │  - ContentRepository                                 │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↑
┌─────────────────────────────────────────────────────────────┐
│                  Infrastructure Layer                        │
│                  (基础设施层)                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Repository Implementation (仓储实现)                 │   │
│  │  - SocialGraphRepositoryImpl                         │   │
│  │  - ContentRepositoryImpl                             │   │
│  │  - 数据库访问、PO转换                                 │   │
│  └──────────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Persistence Object (持久化对象)                      │   │
│  │  - FollowPO                                          │   │
│  │  - PostPO                                            │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 依赖方向

```
Interface → Application → Domain ← Infrastructure
```

- 所有层都依赖领域层
- 领域层不依赖任何外层
- 基础设施层实现领域层定义的接口

## 数据流转

### 请求流程

```
1. RPC Request
   ↓
2. RecommendationHandler (接口层)
   - 参数验证
   - 调用应用服务
   ↓
3. RecommendationService (应用层)
   - 调用领域服务
   - 跨服务调用
   - DTO转换
   ↓
4. RecommendationGenerator (领域服务)
   - 核心业务逻辑
   - 创建聚合
   ↓
5. Repository (仓储)
   - 数据访问
   ↓
6. Database
```

### 响应流程

```
1. Database
   ↓
2. Repository (PO → 领域对象)
   ↓
3. Domain Service (返回聚合)
   ↓
4. Application Service (领域对象 → DTO)
   ↓
5. Handler (DTO → RPC Response)
   ↓
6. RPC Response
```

## 聚合边界

```
┌─────────────────────────────────────┐
│  UserRecommendation (聚合根)         │
│  ┌───────────────────────────────┐  │
│  │  - id: RecommendationID       │  │
│  │  - targetUserID: UserID       │  │
│  │  - reason: RecommendationReason│ │
│  │  - score: int                 │  │
│  │  - createdAt: Time            │  │
│  │  - expiresAt: Time            │  │
│  └───────────────────────────────┘  │
│                                      │
│  业务规则：                           │
│  - 推荐分数计算                       │
│  - 过期判断                           │
│  - 刷新推荐                           │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  RecommendationList (聚合根)         │
│  ┌───────────────────────────────┐  │
│  │  - forUserID: UserID          │  │
│  │  - recommendations: []        │  │
│  │  - generatedAt: Time          │  │
│  └───────────────────────────────┘  │
│                                      │
│  业务规则：                           │
│  - 不能推荐自己                       │
│  - 不能重复推荐                       │
│  - 获取Top N                         │
│  - 移除过期                           │
└─────────────────────────────────────┘
```

## 关键设计模式

### 1. 工厂模式
```go
// 聚合通过工厂方法创建，确保业务规则
recommendation, err := aggregate.NewUserRecommendation(...)
```

### 2. 仓储模式
```go
// 接口定义在领域层，实现在基础设施层
type SocialGraphRepository interface {
    GetFollowings(...) ([]UserID, error)
}
```

### 3. 领域服务模式
```go
// 跨聚合的业务逻辑放在领域服务
generator.GenerateFollowingBasedRecommendations(...)
```

### 4. 值对象模式
```go
// 不可变、无标识、封装验证规则
userID, err := valueobject.NewUserID(123)
```
